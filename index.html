<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta content="width=device-width,minimum-scale=1" name="viewport">
        <title>MS Index</title>
        <link rel="shortcut icon" type="image/png" href="/img/conifer.png">
        <link rel="stylesheet" type="text/css" href="/css/global.css">
        <script type="module">
          import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";

          var maxQButton = document.getElementById('maxQButton');
          var maxButton = document.getElementById('maxButton');
          var tenYearButton = document.getElementById('tenYearButton');
          var fiveYearButton = document.getElementById('fiveYearButton');
          var oneYearButton = document.getElementById('oneYearButton');

          makeGraph("oneYear");
          makeGraph("fiveYear");
          makeGraph("tenYear");
          makeGraph("max", true);
          makeGraph("max");

          maxQButton.addEventListener('click', openGraph);
          maxButton.addEventListener('click', openGraph);
          tenYearButton.addEventListener('click', openGraph);
          fiveYearButton.addEventListener('click', openGraph);
          oneYearButton.addEventListener('click', openGraph);

          document.getElementById("maxButton").click();

          function openGraph(evt) {
            // Declare all variables
            var i, tabcontent, tablinks;

            // Get all elements with class="tabcontent" and hide them
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
              tabcontent[i].style.display = "none";
            }

            // Get all elements with class="tablinks" and remove the class "active"
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
              tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            // Show the current tab, and add an "active" class to the button that opened the tab
            let name = evt.currentTarget.id;
            let chartName = name.substring(0, name.length - 6);

            document.getElementById(chartName).style.display = "block";
          }

          function makeGraph(graphName, quartiles = false){
            var width = 500;
            var height = 380;
            var padding = 30;
            var margin = {top: 20, right: 30, bottom: 30, left: 25};
            var filename = "./json/" + graphName + ".json";
            var days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

            d3.json(filename).then(function(rawData) {
                  const data = rawData.map(({ date, ...object }) => ({
                      ...object,
                      date: new Date(date + " 00:00:00"),
                  }));
              var options = {year:'numeric', month:'long', day:'numeric'};
                  var lastDate = data[data.length - 1].date;
              var lastDateStr = lastDate.toLocaleDateString("en-US", options);
              var lastvalue = (data[data.length - 1].index).toFixed(2);
              var weekday = lastDate.getDay();

              var update = "On " + days[weekday] + " " + lastDateStr + " the MS Index was at " + lastvalue;
              d3.select("#currentindex").text(update)

              var x = d3.scaleUtc()
                .domain(d3.extent(data, d => d.date))
                .range([margin.left, width - margin.right])

              var y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.index)]).nice()
                .range([height - margin.bottom, margin.top])

              var xAxis = g => g
                .attr("transform", `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(x).ticks(width / 90).tickSizeOuter(0))


              var yAxis = g => g
              .attr("transform", `translate(${margin.left},0)`)
              .call(d3.axisLeft(y))
              .call(g => g.select(".domain").remove())
              .call(g => g.select(".tick:last-of-type text").clone()
                .text(data.y))

              var line = d3.line()
                .x(function(d) { return x(d.date); })
                .y(function(d) { return y(d.index); });

              var graphId = "#".concat(graphName);
                  if (quartiles) {
                      graphId = graphId.concat("Q");
                  }
              var svg = d3.select(graphId)
                .append("svg")
                .attr("viewBox", [0, 0, width, height])
                .attr("id", "chart");

              svg.append("g")
                .call(xAxis);

              svg.append("g")
              .call(yAxis);


            svg.append("path")
              .datum(data)
              .attr("fill", "none")
              .attr("stroke", "steelblue")
              .attr("stroke-width", 1.5)
              .attr("stroke-linejoin", "round")
              .attr("stroke-linecap", "round")
              .attr("d", line);

                if (quartiles) {
                const points = Array.from(data, x => x.index);
                const asc = arr => arr.sort((a, b) => a - b);
                const sum = arr => arr.reduce((a, b) => a + b, 0);
                const mean = arr => sum(arr) / arr.length;
                const quantile = (arr, q) => {
                    const sorted = asc(arr);
                    const pos = (sorted.length - 1) * q;
                    const base = Math.floor(pos);
                    const rest = pos - base;
                    if (sorted[base + 1] !== undefined) {
                  return sorted[base] + rest * (sorted[base + 1] - sorted[base]);
                    } else {
                  return sorted[base];
                    }
                };

                const q25 = arr => quantile(arr, .25);
                const q50 = arr => quantile(arr, .50);
                const q75 = arr => quantile(arr, .75);
                const quartiles = [q25(points), q50(points), q75(points)]
                quartiles.forEach(function (x, index) {
                    svg.append("line")
                      .style("stroke", "grey")
                      .attr("class", "quartile")
                      .attr("x1", 30)
                      .attr("y1", y(x))
                      .attr("x2", 475)
                      .attr("y2", y(x));
                });
                }
          });
        }
        </script>
    </head>

    <body>
        <div class="pad2y limiter content">
            <h1>Mises Stationarity Index</h1>
            <div class="body">
                <p id="currentindex"></p>
                <div class="tab">
                    <button class="tablinks" id="maxQButton">Max Quartiles</button>
                    <button class="tablinks" id="maxButton">Max</button>
                    <button class="tablinks" id="tenYearButton">10 Year</button>
                    <button class="tablinks" id="fiveYearButton">5 Year</button>
                    <button class="tablinks" id="oneYearButton">1 Year</button>
                </div>

                <div id="maxQ" class="tabcontent"></div>
                <div id="max" class="tabcontent"></div>
                <div id="tenYear" class="tabcontent"></div>
                <div id="fiveYear" class="tabcontent"></div>
                <div id="oneYear" class="tabcontent"></div>
                <h2>What is it?</h2>
                <p>
                    An index presented in the book: The Dao of Capital
                    by Mark Spitznagel. A similiar unscaled index can be found 
		    <a href="https://fred.stlouisfed.org/series/NCBCEPNW">here</a>.
                </p>

                <h2>How is it calculated?</h2>
                <p>
                    All source code is available 
                    <a href="https://github.com/ckrowland/msindex">here</a>.
                </p>
                <p>
                    The MS index is the expected return on invested capital 
                    (equity) divided by the invested capitals replacement value 
                    (net worth), and can be calculated for the U.S. as follows.
                </p>
                <object data="/img/equation.svg" type="image/svg+xml">
                </object>
                <p>
                    The Z.1 Federal quarterly reports give us the data we need.
                    On table B.103 (Balance Sheet of Nonfinancial Corporate
                    Business) line 40 holds the market value of equities
                    outstanding and line 39 holds the net worth.
                </p>
                <p>
                    These reports only come out each quarter, therefore we want
                    a way to estimate the MS Index in the meantime. We can use
                    the U.S. stock market value (S&P 500 Index) to estimate U.S.
                    corporate equity and the most recent Z1 net worth number to
                    estimate the current U.S. corporate net worth.
                </p>

                <p>
                    The final step requires us to scale the index values by the
                    running
                    <a href="https://en.wikipedia.org/wiki/Geometric_mean">
                        geometric mean
                    </a>
                    (P.231 Dao of Capital). To do this, for each nth point
                    <ol>
                        <li>
                            Multiply all previous unscaled index values together
                        </li>
                        <li>
                            Take the nth root of step 1
                        </li>
                        <li>
                            Divide the current index value by step 2
                        </li>
                    </ol>
                    This gives us the graph seen above.
                </p>

                <h2>Data Files</h2>
                <p>The MS Index data files can be downloaded here</p>
                <ul>
                    <li><a href="/json/max.json">Max</a></li>
                    <li><a href="/json/tenYear.json">Ten Year</a></li>
                    <li><a href="/json/fiveYear.json">Five Year</a></li>
                    <li><a href="/json/oneYear.json">One Year</a></li>
                </ul>

                <p>
                    Since FED data starts at 1945, the 1900-45 data can be
                    found
                    <a href="http://www.smithers.co.uk/q_faqs/us-cape-and-q-chart/">
                        here</a>.
                </p>
                <p>
                    Feel free to contact me with suggestions.
                    <a href="mailto:connor.k.rowland@icloud.com">Email</a>
                    or
                    <a href="https://www.x.com/connorkrowland">Twitter</a>
                </p>
                <p>
		    If you want to help keep the server running, you can donate
                    <a href="https://buymeacoffee.com/ckrowland">here</a>.
                </p>
            </div>
        </div>
    </body>
</html>
